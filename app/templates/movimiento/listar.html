{% extends 'listar.html' %}

{% block columnas %}
<tr>
    <th scope="col">id</th>
    <th scope="col">Fecha</a></th>
    <th scope="col">Tipo de movimiento</th>
    <th scope="col">Terminal</th>
</tr>
{% endblock %}

{% block filas %}
{% for m in object_list %}
<tr>
    <td>{{ m.id }}</td>
    <td>{{ m.fecha_mov }}</td>
    <td>{{ m.tipo_mov }}</td>
    <td>{{ m.id_terminal }}</td>
</tr>
{% endfor %}
{% endblock %}
{% block javascript %}
<script type="application/javascript">
    $(document).ready(function () {
        var columnNames = ['id', 'Fecha', 'Tipo de movimiento', 'Terminal'];
        var excludedColumnIndex = columnNames.indexOf('Opciones');  // Opciones no existe aquí, pero lo dejamos por si quieres agregar luego
        
        var table = $("#tabla").DataTable({
            responsive: true,
            initComplete: function () {
                var api = this.api();
                api.columns().every(function (index) {
                    var column = this;
                    var header = $(column.header());
                    
                    if (index !== excludedColumnIndex) {
                        var filterContainer = $('<div class="filter-container"></div>').appendTo(header.empty());
                        $('<label>' + columnNames[index] + '</label>').appendTo(filterContainer);

                        if (index === 1) {
                            // FILTRO POR FECHA
                            $('<label>Fecha inicial:</label>').appendTo(filterContainer);
                            var startDateInput = $('<input type="date" placeholder="Desde">').appendTo(filterContainer);
                            
                            $('<label>Fecha final:</label>').appendTo(filterContainer);
                            var endDateInput = $('<input type="date" placeholder="Hasta">').appendTo(filterContainer);

                            startDateInput.add(endDateInput).on('change', function () {
                                var startDate = startDateInput.val();
                                var endDate = endDateInput.val();

                                var start = startDate ? new Date(startDate + "T00:00:00") : null;
                                var end = endDate ? new Date(endDate + "T23:59:59") : null;

                                // Limpiar cualquier búsqueda previa
                                $.fn.dataTable.ext.search = [];

                                // Filtro personalizado
                                $.fn.dataTable.ext.search.push(function (settings, data, dataIndex) {
                                    var fechaTexto = data[1]; // Columna Fecha
                                    var fechaData = new Date(fechaTexto);

                                    if ((start && fechaData < start) || (end && fechaData > end)) {
                                        return false;
                                    }
                                    return true;
                                });

                                table.draw();
                            });

                        } else {
                            // FILTRO NORMAL (select dropdown)
                            var select = $('<select><option value="">Todos</option></select>')
                                .appendTo(filterContainer)
                                .on('change', function () {
                                    var val = $.fn.dataTable.util.escapeRegex($(this).val());
                                    column
                                        .search(val ? '^' + val + '$' : '', true, false)
                                        .draw();
                                });
                            column.data().unique().sort().each(function (d, j) {
                                select.append('<option value="' + d + '">' + d + '</option>');
                            });
                        }
                    } else {
                        $('<label>' + columnNames[index] + '</label>').appendTo(header.empty());
                    }
                });
            }
        });
    });
</script>
{% endblock %}